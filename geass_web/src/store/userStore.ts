// src/store/user.ts
// ============================================
//  ç”¨æˆ·å…¨å±€çŠ¶æ€ç®¡ç†ï¼ˆZustandï¼Œä»…å†…å­˜ï¼‰
// ============================================
//
// åŠŸèƒ½ï¼š
// - ä¿å­˜ç™»å½•åç”¨æˆ·ä¿¡æ¯ï¼ˆusername / role / avatar ç­‰ï¼‰
// - ä»…æŒä¹…åŒ– tokenï¼ˆå†™å…¥ localStorageï¼‰
// - é¡µé¢åˆ·æ–°å user ä¿¡æ¯ä¼šè¢«æ¸…ç©ºï¼ˆé‡æ–°é€šè¿‡ token æ‹‰å–ï¼‰
// - å¯ä¿®æ”¹ roleã€avatar å­—æ®µ
// - ç™»å‡ºæ—¶æ¸…é™¤ token + æ¸…ç©ºå†…å­˜çŠ¶æ€
//

import { create } from "zustand";

// ============================================
// ğŸ§© ç”¨æˆ·ä¿¡æ¯ç»“æ„å®šä¹‰
// ============================================
export interface UserState {
  username: string;
  name: string;
  email: string;
  token: string;
  role: number;
  avatar: string;
  userId: number;
}

// ============================================
// ğŸ§© Storeï¼ˆçŠ¶æ€å®¹å™¨ï¼‰å®šä¹‰
// ============================================
interface StoreState {
  user: UserState | null; // å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼ˆä»…å†…å­˜ä¿å­˜ï¼‰
  setUser: (user: UserState) => void; // ç™»å½•åä¿å­˜ç”¨æˆ·ä¿¡æ¯
  updateUserInfo: (
    partial: Partial<Pick<UserState, "role" | "avatar">>
  ) => void; // ä¿®æ”¹æƒé™æˆ–å¤´åƒ
  clearUser: () => void; // é€€å‡ºç™»å½•æ—¶æ¸…é™¤çŠ¶æ€ + åˆ é™¤ token
}

// ============================================
// âš™ï¸ Zustand Storeï¼ˆä¸ä½¿ç”¨ persistï¼‰
// ============================================
// user ä¿¡æ¯ä»…å­˜åœ¨å†…å­˜ä¸­ï¼›token å•ç‹¬æŒä¹…åŒ–ã€‚
export const useUserStore = create<StoreState>((set) => ({
  // åˆå§‹çŠ¶æ€
  user: null,

  // ============================================
  // ğŸ” ç™»å½•æˆåŠŸæ—¶è°ƒç”¨ï¼šä¿å­˜ç”¨æˆ·ä¿¡æ¯ + token
  // ============================================
  setUser: (user) => {
    // âœ… token å•ç‹¬æŒä¹…åŒ–ï¼ˆä¾› axios ä½¿ç”¨ï¼‰
    localStorage.setItem("token", user.token);

    // âœ… ä»…åœ¨å†…å­˜ä¸­ä¿å­˜å®Œæ•´ user ä¿¡æ¯
    set({ user });
  },

  // ============================================
  // ğŸ”„ æ›´æ–°éƒ¨åˆ†ç”¨æˆ·ä¿¡æ¯ï¼ˆå¦‚å¤´åƒã€è§’è‰²ï¼‰
  // ============================================
  updateUserInfo: (partial) =>
    set((state) =>
      state.user ? { user: { ...state.user, ...partial } } : { user: null }
    ),

  // ============================================
  // ğŸšª é€€å‡ºç™»å½•ï¼šæ¸…é™¤çŠ¶æ€ + åˆ é™¤ token
  // ============================================
  clearUser: () => {
    localStorage.removeItem("token");
    set({ user: null });
  },
}));
